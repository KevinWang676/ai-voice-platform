{% extends "base.html" %}

{% block content %}
<section class="hero-section text-center text-white">
    <div class="container">
        <h1 class="display-4 animate__animated animate__fadeIn mb-4">管理员后台</h1>
        <p class="lead animate__animated animate__fadeIn animate__delay-1s">用户管理面板</p>
    </div>
</section>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="card shadow-lg" style="margin-top: -4rem;">
                <div class="card-body p-5">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert {% if category == 'error' %}alert-danger{% else %}alert-success{% endif %} animate__animated animate__fadeIn">
                                    {{ message }}
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <div class="container mt-4">
                        <h1>管理员面板</h1>
                        
                        <!-- 用户管理 -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h2 class="h5 mb-0">用户管理</h2>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>用户名</th>
                                                <th>邮箱</th>
                                                <th>注册时间</th>
                                                <th>已验证</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for user in users.items %}
                                            <tr>
                                                <td>{{ user.id }}</td>
                                                <td>{{ user.username }}</td>
                                                <td>{{ user.email }}</td>
                                                <td>{{ (user.created_at|add_hours).strftime('%m-%d %H:%M') if user.created_at else '未知' }}</td>
                                                <td>{{ '是' if user.is_verified else '否' }}</td>
                                                <td>
                                                    <form action="{{ url_for('toggle_verification', user_id=user.id) }}" method="post" class="d-inline">
                                                        <button type="submit" class="btn btn-sm btn-outline-primary">
                                                            {{ '取消验证' if user.is_verified else '验证' }}
                                                        </button>
                                                    </form>
                                                    <form action="{{ url_for('reset_password', user_id=user.id) }}" method="post" class="d-inline"
                                                        onsubmit="return confirm('确定要重置该用户的密码吗？')">
                                                        <button type="submit" class="btn btn-sm btn-outline-warning">重置密码</button>
                                                    </form>
                                                    {% if user.id != 1 %}
                                                    <form action="{{ url_for('delete_user', user_id=user.id) }}" method="post" class="d-inline"
                                                        onsubmit="return confirm('确定要删除该用户吗？此操作不可恢复！')">
                                                        <button type="submit" class="btn btn-sm btn-outline-danger">删除</button>
                                                    </form>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    <!-- Users Pagination -->
                                    {% if users.pages > 1 %}
                                    <nav aria-label="User pagination" class="mt-3">
                                        <ul class="pagination justify-content-center">
                                            <li class="page-item {{ 'disabled' if users.page == 1 }}">
                                                <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.prev_num, posts_page=posts.page, comments_page=comments.page, stories_page=stories.page) if users.has_prev else '#' }}">上一页</a>
                                            </li>
                                            {% for page in range(1, users.pages + 1) %}
                                            <li class="page-item {{ 'active' if page == users.page }}">
                                                <a class="page-link" href="{{ url_for('admin_login_page', users_page=page, posts_page=posts.page, comments_page=comments.page, stories_page=stories.page) }}">{{ page }}</a>
                                            </li>
                                            {% endfor %}
                                            <li class="page-item {{ 'disabled' if users.page == users.pages }}">
                                                <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.next_num, posts_page=posts.page, comments_page=comments.page, stories_page=stories.page) if users.has_next else '#' }}">下一页</a>
                                            </li>
                                        </ul>
                                    </nav>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- 帖子管理 -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h2 class="h5 mb-0">帖子管理</h2>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <form action="{{ url_for('delete_all_posts') }}" method="post" class="mb-3"
                                        onsubmit="return confirm('确定要删除所有帖子吗？此操作不可恢复！')">
                                        <button type="submit" class="btn btn-danger">
                                            <i class="fas fa-trash-alt me-1"></i>删除所有帖子
                                        </button>
                                    </form>
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>标题</th>
                                                <th>作者</th>
                                                <th>发布时间</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for post in posts.items %}
                                            <tr>
                                                <td>{{ post.id }}</td>
                                                <td>
                                                    <a href="{{ url_for('view_post', post_id=post.id) }}" target="_blank">
                                                        {{ post.title }}
                                                    </a>
                                                </td>
                                                <td>{{ post.user.username if post.user else '未知' }}</td>
                                                <td>{{ (post.created_at|add_hours).strftime('%m-%d %H:%M') if post.created_at else '未知' }}</td>
                                                <td>
                                                    <form action="{{ url_for('delete_post', post_id=post.id) }}" method="post" class="d-inline"
                                                        onsubmit="return confirm('确定要删除这篇帖子吗？')">
                                                        <button type="submit" class="btn btn-sm btn-outline-danger">删除</button>
                                                    </form>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    <!-- Posts Pagination -->
                                    {% if posts.pages > 1 %}
                                    <nav aria-label="Post pagination" class="mt-3">
                                        <ul class="pagination justify-content-center">
                                            <li class="page-item {{ 'disabled' if posts.page == 1 }}">
                                                <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.page, posts_page=posts.prev_num, comments_page=comments.page, stories_page=stories.page) if posts.has_prev else '#' }}">上一页</a>
                                            </li>
                                            {% for page in range(1, posts.pages + 1) %}
                                            <li class="page-item {{ 'active' if page == posts.page }}">
                                                <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.page, posts_page=page, comments_page=comments.page, stories_page=stories.page) }}">{{ page }}</a>
                                            </li>
                                            {% endfor %}
                                            <li class="page-item {{ 'disabled' if posts.page == posts.pages }}">
                                                <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.page, posts_page=posts.next_num, comments_page=comments.page, stories_page=stories.page) if posts.has_next else '#' }}">下一页</a>
                                            </li>
                                        </ul>
                                    </nav>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- 评论管理 -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h2 class="h5 mb-0">评论管理</h2>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>内容</th>
                                                <th>作者</th>
                                                <th>所属帖子</th>
                                                <th>发布时间</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for comment in comments.items %}
                                            <tr>
                                                <td>{{ comment.id }}</td>
                                                <td>{{ comment.content }}</td>
                                                <td>{{ comment.user.username if comment.user else '未知' }}</td>
                                                <td>
                                                    <a href="{{ url_for('view_post', post_id=comment.post.id) }}" target="_blank">
                                                        {{ comment.post.title }}
                                                    </a>
                                                </td>
                                                <td>{{ (comment.created_at|add_hours).strftime('%m-%d %H:%M') if comment.created_at else '未知' }}</td>
                                                <td>
                                                    <form action="{{ url_for('delete_comment', comment_id=comment.id) }}" method="post" class="d-inline"
                                                        onsubmit="return confirm('确定要删除这条评论吗？')">
                                                        <button type="submit" class="btn btn-sm btn-outline-danger">删除</button>
                                                    </form>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    <!-- Comments Pagination -->
                                    {% if comments.pages > 1 %}
                                    <nav aria-label="Comment pagination" class="mt-3">
                                        <ul class="pagination justify-content-center">
                                            <li class="page-item {{ 'disabled' if comments.page == 1 }}">
                                                <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.page, posts_page=posts.page, comments_page=comments.prev_num, stories_page=stories.page) if comments.has_prev else '#' }}">上一页</a>
                                            </li>
                                            {% for page in range(1, comments.pages + 1) %}
                                            <li class="page-item {{ 'active' if page == comments.page }}">
                                                <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.page, posts_page=posts.page, comments_page=page, stories_page=stories.page) }}">{{ page }}</a>
                                            </li>
                                            {% endfor %}
                                            <li class="page-item {{ 'disabled' if comments.page == comments.pages }}">
                                                <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.page, posts_page=posts.page, comments_page=comments.next_num, stories_page=stories.page) if comments.has_next else '#' }}">下一页</a>
                                            </li>
                                        </ul>
                                    </nav>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- 故事管理 -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h2 class="h5 mb-0">故事管理</h2>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <form action="{{ url_for('delete_all_stories') }}" method="post" class="mb-3"
                                        onsubmit="return confirm('确定要删除所有故事吗？此操作不可恢复！')">
                                        <button type="submit" class="btn btn-danger">
                                            <i class="fas fa-trash-alt me-1"></i>删除所有故事
                                        </button>
                                    </form>
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>标题</th>
                                                <th>创建者</th>
                                                <th>创建时间</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for story in stories.items %}
                                            <tr>
                                                <td>{{ story.id }}</td>
                                                <td>{{ story.title }}</td>
                                                <td>{{ story.user.username if story.user else '未知' }}</td>
                                                <td>{{ (story.created_at|add_hours).strftime('%m-%d %H:%M') if story.created_at else '未知' }}</td>
                                                <td>
                                                    <button type="button" class="btn btn-sm btn-outline-info" 
                                                            data-bs-toggle="modal" 
                                                            data-bs-target="#storyModal{{ story.id }}">
                                                        查看内容
                                                    </button>
                                                    <form action="{{ url_for('delete_story', story_id=story.id) }}" method="post" class="d-inline"
                                                        onsubmit="return confirm('确定要删除这个故事吗？')">
                                                        <button type="submit" class="btn btn-sm btn-outline-danger">删除</button>
                                                    </form>
                                                </td>
                                            </tr>

                                            <!-- Story Content Modal -->
                                            <div class="modal fade" id="storyModal{{ story.id }}" tabindex="-1" aria-hidden="true">
                                                <div class="modal-dialog modal-lg">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title">{{ story.title }}</h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <form action="{{ url_for('edit_story', story_id=story.id) }}" method="post">
                                                                <div class="mb-3">
                                                                    <label for="storyContent{{ story.id }}" class="form-label">故事内容</label>
                                                                    <textarea class="form-control" id="storyContent{{ story.id }}" 
                                                                              name="content" rows="15" style="white-space: pre-wrap;">{{ story.original_content }}</textarea>
                                                                </div>
                                                                <div class="text-end">
                                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                                                    <button type="submit" class="btn btn-primary">保存修改</button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    <!-- Stories Pagination -->
                                    {% if stories.pages > 1 %}
                                    <nav aria-label="Story pagination" class="mt-3">
                                        <ul class="pagination justify-content-center">
                                            <li class="page-item {{ 'disabled' if stories.page == 1 }}">
                                                <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.page, posts_page=posts.page, comments_page=comments.page, stories_page=stories.prev_num) if stories.has_prev else '#' }}">上一页</a>
                                            </li>
                                            {% for page in range(1, stories.pages + 1) %}
                                            <li class="page-item {{ 'active' if page == stories.page }}">
                                                <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.page, posts_page=posts.page, comments_page=comments.page, stories_page=page) }}">{{ page }}</a>
                                            </li>
                                            {% endfor %}
                                            <li class="page-item {{ 'disabled' if stories.page == stories.pages }}">
                                                <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.page, posts_page=posts.page, comments_page=comments.page, stories_page=stories.next_num) if stories.has_next else '#' }}">下一页</a>
                                            </li>
                                        </ul>
                                    </nav>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- 角色派对设置管理 -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h2 class="h5 mb-0">角色派对设置管理</h2>
                                <span class="badge bg-primary">{{ group_chat_settings.total }} 个设置</span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>用户</th>
                                                <th>角色A</th>
                                                <th style="width: 25%;">角色A设置</th>
                                                <th>角色B</th>
                                                <th style="width: 25%;">角色B设置</th>
                                                <th>最近使用时间</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for setting in group_chat_settings.items %}
                                            <tr>
                                                <td>{{ setting.id }}</td>
                                                <td>{{ setting.user.username if setting.user else '未知' }}</td>
                                                <td>{{ setting.agent_a_character }}</td>
                                                <td class="text-muted" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                                                    <small>{{ setting.agent_a_setting|truncate_text(80) }}</small>
                                                </td>
                                                <td>{{ setting.agent_b_character }}</td>
                                                <td class="text-muted" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                                                    <small>{{ setting.agent_b_setting|truncate_text(80) }}</small>
                                                </td>
                                                <td>{{ (setting.last_used_at|add_hours).strftime('%m-%d %H:%M') if setting.last_used_at else '未知' }}</td>
                                                <td>
                                                    <button type="button" class="btn btn-sm btn-outline-info" 
                                                            data-bs-toggle="modal" 
                                                            data-bs-target="#groupChatSettingModal{{ setting.id }}">
                                                        查看详情
                                                    </button>
                                                </td>
                                            </tr>

                                            <!-- Group Chat Setting Modal -->
                                            <div class="modal fade" id="groupChatSettingModal{{ setting.id }}" tabindex="-1" aria-hidden="true">
                                                <div class="modal-dialog modal-lg">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title">{{ setting.user.username }} 的角色派对设置</h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <div class="mb-3">
                                                                <h6>角色A: {{ setting.agent_a_character }}</h6>
                                                                <div class="border p-3 bg-light rounded mb-3" style="white-space: pre-wrap; word-break: break-word; max-height: 300px; overflow-y: auto;">{{ setting.agent_a_setting }}</div>
                                                                
                                                                <h6>角色B: {{ setting.agent_b_character }}</h6>
                                                                <div class="border p-3 bg-light rounded" style="white-space: pre-wrap; word-break: break-word; max-height: 300px; overflow-y: auto;">{{ setting.agent_b_setting }}</div>
                                                            </div>
                                                            <div class="d-flex justify-content-between">
                                                                <small class="text-muted">创建时间: {{ (setting.created_at|add_hours).strftime('%Y-%m-%d %H:%M') }}</small>
                                                                <small class="text-muted">最近使用: {{ (setting.last_used_at|add_hours).strftime('%Y-%m-%d %H:%M') }}</small>
                                                            </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <form action="{{ url_for('admin_delete_group_chat_setting', setting_id=setting.id) }}" method="POST" class="d-inline">
                                                                <button type="submit" class="btn btn-danger" onclick="return confirm('确定要删除这个角色派对设置吗？')">
                                                                    删除设置
                                                                </button>
                                                            </form>
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    
                                    <!-- Group Chat Settings Pagination -->
                                    {% if group_chat_settings.pages > 1 %}
                                    <nav aria-label="Group chat settings pagination" class="mt-3">
                                        <ul class="pagination justify-content-center">
                                            <li class="page-item {{ 'disabled' if group_chat_settings.page == 1 }}">
                                                <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.page, posts_page=posts.page, comments_page=comments.page, stories_page=stories.page, announcement_history_page=announcement_history.page, group_chat_settings_page=group_chat_settings.prev_num) if group_chat_settings.has_prev else '#' }}">上一页</a>
                                            </li>
                                            {% for page in range(1, group_chat_settings.pages + 1) %}
                                            <li class="page-item {{ 'active' if page == group_chat_settings.page }}">
                                                <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.page, posts_page=posts.page, comments_page=comments.page, stories_page=stories.page, announcement_history_page=announcement_history.page, group_chat_settings_page=page) }}">{{ page }}</a>
                                            </li>
                                            {% endfor %}
                                            <li class="page-item {{ 'disabled' if group_chat_settings.page == group_chat_settings.pages }}">
                                                <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.page, posts_page=posts.page, comments_page=comments.page, stories_page=stories.page, announcement_history_page=announcement_history.page, group_chat_settings_page=group_chat_settings.next_num) if group_chat_settings.has_next else '#' }}">下一页</a>
                                            </li>
                                        </ul>
                                    </nav>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- 社区公告管理 -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h2 class="h5 mb-0">社区公告管理</h2>
                            </div>
                            <div class="card-body">
                                <form action="{{ url_for('update_announcement') }}" method="post">
                                    <div class="mb-3">
                                        <label for="announcement" class="form-label">公告内容</label>
                                        <textarea class="form-control" id="announcement" name="content" rows="4">{{ announcement.content if announcement else '' }}</textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">更新公告</button>
                                </form>

                                <!-- 公告历史记录 -->
                                <div class="mt-4">
                                    <h3 class="h6 mb-3">历史公告记录</h3>
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>发布时间</th>
                                                    <th>公告内容</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for history in announcement_history.items %}
                                                <tr>
                                                    <td>{{ (history.created_at|add_hours).strftime('%m-%d %H:%M') }}</td>
                                                    <td>{{ history.content }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                        
                                        <!-- Announcement History Pagination -->
                                        {% if announcement_history.pages > 1 %}
                                        <nav aria-label="Announcement history pagination" class="mt-3">
                                            <ul class="pagination justify-content-center">
                                                <li class="page-item {{ 'disabled' if announcement_history.page == 1 }}">
                                                    <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.page, posts_page=posts.page, comments_page=comments.page, stories_page=stories.page, announcement_history_page=announcement_history.prev_num) if announcement_history.has_prev else '#' }}">上一页</a>
                                                </li>
                                                {% for page in range(1, announcement_history.pages + 1) %}
                                                <li class="page-item {{ 'active' if page == announcement_history.page }}">
                                                    <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.page, posts_page=posts.page, comments_page=comments.page, stories_page=stories.page, announcement_history_page=page) }}">{{ page }}</a>
                                                </li>
                                                {% endfor %}
                                                <li class="page-item {{ 'disabled' if announcement_history.page == announcement_history.pages }}">
                                                    <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.page, posts_page=posts.page, comments_page=comments.page, stories_page=stories.page, announcement_history_page=announcement_history.next_num) if announcement_history.has_next else '#' }}">下一页</a>
                                                </li>
                                            </ul>
                                        </nav>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 密钥管理 -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h2 class="h5 mb-0">密钥管理</h2>
                                <span class="badge bg-primary">{{ secret_keys.total if secret_keys else 0 }} 个密钥</span>
                            </div>
                            <div class="card-body">
                                <!-- 添加新密钥 -->
                                <form action="/admin/secret_keys/add" method="post" class="mb-4">
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="key" placeholder="输入新密钥" required>
                                        <button type="submit" class="btn btn-primary">添加密钥</button>
                                    </div>
                                </form>

                                <!-- 批量导入密钥 -->
                                <form action="/admin/secret_keys/import" method="post" class="mb-4" enctype="multipart/form-data">
                                    <div class="input-group">
                                        <input type="file" class="form-control" name="keys_file" accept=".txt" required>
                                        <button type="submit" class="btn btn-primary">批量导入</button>
                                    </div>
                                    <small class="form-text text-muted">上传包含密钥的TXT文件，每行一个密钥</small>
                                </form>

                                <!-- 密钥列表 -->
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>序号</th>
                                                <th>密钥</th>
                                                <th>状态</th>
                                                <th>创建时间</th>
                                                <th>最后使用时间</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for key in secret_keys.items if secret_keys %}
                                            <tr>
                                                <td>{{ loop.index + (secret_keys.page-1) * secret_keys.per_page }}</td>
                                                <td><code>{{ key.key }}</code></td>
                                                <td>
                                                    {% if key.is_used %}
                                                    <span class="badge bg-success">已使用</span>
                                                    {% else %}
                                                    <span class="badge bg-secondary">未使用</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ (key.created_at|add_hours).strftime('%Y-%m-%d %H:%M') if key.created_at else '未知' }}</td>
                                                <td>{{ (key.last_used_at|add_hours).strftime('%Y-%m-%d %H:%M') if key.last_used_at else '未使用' }}</td>
                                                <td>
                                                    <form action="/admin/secret_keys/{{ key.id }}/delete" method="post" class="d-inline"
                                                        onsubmit="return confirm('确定要删除此密钥吗？如果已经分发出去，删除后将无法使用。')">
                                                        <button type="submit" class="btn btn-sm btn-outline-danger">删除</button>
                                                    </form>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>

                                    <!-- Secret Keys Pagination -->
                                    {% if secret_keys and secret_keys.pages > 1 %}
                                    <nav aria-label="Secret keys pagination" class="mt-3">
                                        <ul class="pagination justify-content-center">
                                            <li class="page-item {{ 'disabled' if secret_keys.page == 1 }}">
                                                <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.page, posts_page=posts.page, comments_page=comments.page, stories_page=stories.page, announcement_history_page=announcement_history.page, secret_keys_page=secret_keys.prev_num) if secret_keys.has_prev else '#' }}">上一页</a>
                                            </li>
                                            {% for page in range(1, secret_keys.pages + 1) %}
                                            <li class="page-item {{ 'active' if page == secret_keys.page }}">
                                                <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.page, posts_page=posts.page, comments_page=comments.page, stories_page=stories.page, announcement_history_page=announcement_history.page, secret_keys_page=page) }}">{{ page }}</a>
                                            </li>
                                            {% endfor %}
                                            <li class="page-item {{ 'disabled' if secret_keys.page == secret_keys.pages }}">
                                                <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.page, posts_page=posts.page, comments_page=comments.page, stories_page=stories.page, announcement_history_page=announcement_history.page, secret_keys_page=secret_keys.next_num) if secret_keys.has_next else '#' }}">下一页</a>
                                            </li>
                                        </ul>
                                    </nav>
                                    {% endif %}
                                </div>

                                <!-- 下载和导出 -->
                                <div class="mt-4 d-flex justify-content-between">
                                    <a href="/admin/secret_keys/export" class="btn btn-outline-secondary">
                                        <i class="fas fa-download me-1"></i>导出所有密钥
                                    </a>
                                    <a href="/admin/secret_keys/export_unused" class="btn btn-outline-primary">
                                        <i class="fas fa-download me-1"></i>仅导出未使用密钥
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- 角色聊天管理 -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h2 class="h5 mb-0">角色聊天管理</h2>
                                <span class="badge bg-primary">{{ character_chats.total }} 个聊天记录</span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <form action="{{ url_for('admin_delete_all_character_chats') }}" method="post" class="mb-3"
                                        onsubmit="return confirm('确定要删除所有角色聊天记录吗？此操作不可恢复！')">
                                        <button type="submit" class="btn btn-danger">
                                            <i class="fas fa-trash-alt me-1"></i>删除所有角色聊天记录
                                        </button>
                                    </form>
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>用户</th>
                                                <th>角色名称</th>
                                                <th>消息数量</th>
                                                <th>创建时间</th>
                                                <th>最近更新</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for chat in character_chats.items %}
                                            <tr>
                                                <td>{{ chat.id }}</td>
                                                <td>{{ chat.user.username if chat.user else '未知' }}</td>
                                                <td>{{ chat.character_name }}</td>
                                                <td>
                                                    {% set chat_history = chat.chat_history|json_loads %}
                                                    {{ chat_history|length // 2 }} 条
                                                </td>
                                                <td>{{ (chat.created_at|add_hours).strftime('%m-%d %H:%M') if chat.created_at else '未知' }}</td>
                                                <td>{{ (chat.updated_at|add_hours).strftime('%m-%d %H:%M') if chat.updated_at else '未知' }}</td>
                                                <td>
                                                    <button type="button" class="btn btn-sm btn-outline-info" 
                                                            data-bs-toggle="modal" 
                                                            data-bs-target="#characterChatModal{{ chat.id }}">
                                                        查看详情
                                                    </button>
                                                    <form action="{{ url_for('admin_delete_character_chat', chat_id=chat.id) }}" method="post" class="d-inline"
                                                        onsubmit="return confirm('确定要删除这个角色聊天记录吗？此操作不可恢复！')">
                                                        <button type="submit" class="btn btn-sm btn-outline-danger">删除</button>
                                                    </form>
                                                </td>
                                            </tr>

                                            <!-- Character Chat Modal -->
                                            <div class="modal fade" id="characterChatModal{{ chat.id }}" tabindex="-1" aria-hidden="true">
                                                <div class="modal-dialog modal-lg">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title">{{ chat.user.username if chat.user else '未知' }} 的角色聊天记录</h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <!-- 角色设定编辑 -->
                                                            <form action="{{ url_for('admin_edit_character_chat', chat_id=chat.id) }}" method="post">
                                                                <div class="mb-3">
                                                                    <label for="characterDescription{{ chat.id }}" class="form-label">
                                                                        <strong>角色：{{ chat.character_name }}</strong> - 角色设定
                                                                    </label>
                                                                    <textarea class="form-control" id="characterDescription{{ chat.id }}" 
                                                                            name="character_description" rows="8" 
                                                                            style="white-space: pre-wrap;">{{ chat.character_description }}</textarea>
                                                                </div>
                                                                <div class="text-end">
                                                                    <button type="submit" class="btn btn-primary">更新角色设定</button>
                                                                </div>
                                                            </form>
                                                            
                                                            <hr class="my-4">
                                                            
                                                            <!-- 聊天历史 -->
                                                            <h6 class="mb-3">聊天历史记录</h6>
                                                            <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                                                {% set chat_history = chat.chat_history|json_loads %}
                                                                {% if chat_history|length > 0 %}
                                                                    {% for message in chat_history %}
                                                                        <div class="mb-3 p-2 {% if message.role == 'user' %}bg-light rounded-3{% else %}border-start border-primary ps-3{% endif %}">
                                                                            <div class="small text-muted mb-1">{{ message.role|upper }}</div>
                                                                            <div style="white-space: pre-wrap;">{{ message.content }}</div>
                                                                        </div>
                                                                    {% endfor %}
                                                                {% else %}
                                                                    <p class="text-muted text-center">暂无聊天记录</p>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        <div class="modal-footer d-flex justify-content-between">
                                                            <form action="{{ url_for('admin_delete_character_chat', chat_id=chat.id) }}" method="post">
                                                                <button type="submit" class="btn btn-danger" 
                                                                    onclick="return confirm('确定要删除这个角色聊天记录吗？此操作不可恢复！')">
                                                                    删除此聊天记录
                                                                </button>
                                                            </form>
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    
                                    <!-- Character Chats Pagination -->
                                    {% if character_chats.pages > 1 %}
                                    <nav aria-label="Character chats pagination" class="mt-3">
                                        <ul class="pagination justify-content-center">
                                            <li class="page-item {{ 'disabled' if character_chats.page == 1 }}">
                                                <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.page, posts_page=posts.page, comments_page=comments.page, stories_page=stories.page, announcement_history_page=announcement_history.page, group_chat_settings_page=group_chat_settings.page, secret_keys_page=secret_keys.page, character_chats_page=character_chats.prev_num) if character_chats.has_prev else '#' }}">上一页</a>
                                            </li>
                                            {% for page in range(1, character_chats.pages + 1) %}
                                            <li class="page-item {{ 'active' if page == character_chats.page }}">
                                                <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.page, posts_page=posts.page, comments_page=comments.page, stories_page=stories.page, announcement_history_page=announcement_history.page, group_chat_settings_page=group_chat_settings.page, secret_keys_page=secret_keys.page, character_chats_page=page) }}">{{ page }}</a>
                                            </li>
                                            {% endfor %}
                                            <li class="page-item {{ 'disabled' if character_chats.page == character_chats.pages }}">
                                                <a class="page-link" href="{{ url_for('admin_login_page', users_page=users.page, posts_page=posts.page, comments_page=comments.page, stories_page=stories.page, announcement_history_page=announcement_history.page, group_chat_settings_page=group_chat_settings.page, secret_keys_page=secret_keys.page, character_chats_page=character_chats.next_num) if character_chats.has_next else '#' }}">下一页</a>
                                            </li>
                                        </ul>
                                    </nav>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>返回首页
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} 